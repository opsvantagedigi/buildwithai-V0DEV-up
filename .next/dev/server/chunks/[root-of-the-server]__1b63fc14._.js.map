{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai/src/lib/kv.ts"],"sourcesContent":["// Thin Vercel KV adapter. If @vercel/kv is not installed or KV is not configured,\r\n// these functions fail gracefully and return null / noop. A conservative\r\n// no-write fallback is implemented so we can avoid attempting writes when the\r\n// deployment only provides a read-only token.\r\nlet kvClient: any = null\r\n// Flags will be computed after env mapping so they reflect mapped UPSTASH vars\r\nlet WRITE_ENABLED = false\r\nlet READ_ONLY_ONLY = false\r\nlet NO_WRITE_FALLBACK = false\r\n\r\ntry {\r\n  // If the project already has UPSTASH_REDIS_REST_URL / UPSTASH_REDIS_REST_TOKEN\r\n  // or custom WRITE/READ env names set, map them to the names expected by\r\n  // `@vercel/kv` at runtime so the package can pick them up without changing\r\n  // Vercel project env names. Do NOT log values or expose secrets.\r\n  if (!process.env.KV_REST_API_URL) {\r\n    process.env.KV_REST_API_URL = process.env.UPSTASH_REDIS_REST_URL || process.env.KV_REST_API_URL\r\n  }\r\n  if (!process.env.KV_REST_API_TOKEN) {\r\n    process.env.KV_REST_API_TOKEN = process.env.KV_REST_API_WRITE_TOKEN || process.env.UPSTASH_REDIS_REST_TOKEN || process.env.KV_REST_API_READ_ONLY_TOKEN || process.env.KV_REST_API_TOKEN\r\n  }\r\n\r\n  // Compute write/read flags after any env mapping above so they reflect\r\n  // the effective environment variables (e.g. UPSTASH -> KV mapping).\r\n  WRITE_ENABLED = !!(process.env.KV_REST_API_WRITE_TOKEN || process.env.KV_REST_API_TOKEN)\r\n  READ_ONLY_ONLY = !!process.env.KV_REST_API_READ_ONLY_TOKEN && !WRITE_ENABLED\r\n  NO_WRITE_FALLBACK = process.env.NO_WRITE_FALLBACK === 'true' || READ_ONLY_ONLY\r\n\r\n  // If explicit Upstash REST envs are present prefer a thin REST wrapper so\r\n  // local scripts and child processes use the same predictable code-path.\r\n  const earlyUpstashUrl = process.env.UPSTASH_REDIS_REST_URL\r\n  const earlyUpstashToken = process.env.UPSTASH_REDIS_REST_TOKEN\r\n  if (earlyUpstashUrl && earlyUpstashToken) {\r\n    const base = earlyUpstashUrl.replace(/\\/$/, '')\r\n    kvClient = {\r\n      async get(key: string) {\r\n        try {\r\n          const res = await fetch(`${base}/get/${encodeURIComponent(key)}`, {\r\n            headers: { Authorization: `Bearer ${earlyUpstashToken}` },\r\n          })\r\n          if (!res.ok) return null\r\n          const j = await res.json()\r\n          return j.result ?? null\r\n        } catch (err) {\r\n          console.error(\"[KV] early REST get() failed:\", err)\r\n          return null\r\n        }\r\n      },\r\n      async set(key: string, value: any) {\r\n        if (NO_WRITE_FALLBACK) return { skippedReadOnly: true }\r\n        try {\r\n          await fetch(`${base}/set/${encodeURIComponent(key)}`, {\r\n            method: 'POST',\r\n            headers: {\r\n              Authorization: `Bearer ${earlyUpstashToken}`,\r\n              'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({ value: typeof value === 'string' ? value : JSON.stringify(value) }),\r\n          })\r\n          return true\r\n        } catch (err) {\r\n          console.error(\"[KV] early REST set() failed:\", err)\r\n          return null\r\n        }\r\n      },\r\n      async expire(key: string, ttl: number) {\r\n        if (NO_WRITE_FALLBACK) return null\r\n        try {\r\n          await fetch(`${base}/expire/${encodeURIComponent(key)}`, {\r\n            method: 'POST',\r\n            headers: {\r\n              Authorization: `Bearer ${earlyUpstashToken}`,\r\n              'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({ ttl }),\r\n          })\r\n          return true\r\n        } catch (err) {\r\n          console.error(\"[KV] early REST expire() failed:\", err)\r\n          return null\r\n        }\r\n      },\r\n    }\r\n  }\r\n\r\n  // Construct the module name so static analyzers can't find the literal\r\n  const moduleName = '@' + 'vercel' + '/kv'\r\n  // Use eval to call require at runtime; this avoids bundlers resolving the import\r\n  // eslint-disable-next-line @typescript-eslint/no-implied-eval\r\n  // @ts-ignore\r\n  const kvModule = eval('require')(moduleName)\r\n\r\n  // Pick a candidate client from common export shapes\r\n  let candidate: any = kvModule?.kv ?? kvModule?.default ?? kvModule\r\n\r\n  // If the module exports a factory function, attempt to call it with env\r\n  if (typeof candidate === 'function') {\r\n    // Wrap factory in a lazy initializer so child processes or scripts that\r\n    // load env files after module import still work. The lazy wrapper will\r\n    // call the factory on first use with the current env values.\r\n    const factory = candidate\r\n    const makeLazy = (factoryFn: any) => {\r\n      let realClient: any = null\r\n      let initAttempted = false\r\n      const ensure = async () => {\r\n        if (realClient) return realClient\r\n        if (initAttempted) return realClient\r\n        initAttempted = true\r\n        try {\r\n          const url = process.env.KV_REST_API_URL || process.env.UPSTASH_REDIS_REST_URL\r\n          const token = process.env.KV_REST_API_TOKEN || process.env.UPSTASH_REDIS_REST_TOKEN\r\n          realClient = await factoryFn({ url, token })\r\n          if (!(realClient && typeof realClient.get === 'function' && typeof realClient.set === 'function')) {\r\n            realClient = null\r\n          }\r\n        } catch (err) {\r\n          realClient = null\r\n        }\r\n        return realClient\r\n      }\r\n      return {\r\n        async get(k: string) {\r\n          const c = await ensure()\r\n          if (!c) throw new Error('kv_not_initialized')\r\n          return c.get(k)\r\n        },\r\n        async set(k: string, v: any) {\r\n          const c = await ensure()\r\n          if (!c) throw new Error('kv_not_initialized')\r\n          return c.set(k, v)\r\n        },\r\n        async expire(k: string, t: number) {\r\n          const c = await ensure()\r\n          if (!c) throw new Error('kv_not_initialized')\r\n          if (typeof c.expire === 'function') return c.expire(k, t)\r\n          return null\r\n        },\r\n      }\r\n    }\r\n\r\n    try {\r\n      candidate = makeLazy(factory)\r\n    } catch (err) {\r\n      // ignore and validate below\r\n    }\r\n  }\r\n\r\n  // Validate that candidate exposes get/set\r\n  if (candidate && typeof candidate.get === 'function' && typeof candidate.set === 'function') {\r\n    kvClient = candidate\r\n  } else {\r\n    // Diagnostic + force fallback to Upstash REST in the catch block below\r\n    console.warn('[KV] Falling back to Upstash REST wrapper: invalid client shape', Object.keys(kvModule || {}))\r\n    throw new Error('invalid_kv_client_shape')\r\n  }\r\n} catch (e) {\r\n  // package not installed or not available in this environment; try an\r\n  // Upstash REST fallback if UPSTASH_REDIS_REST_URL/TOKEN are available.\r\n  const upstashUrl = process.env.UPSTASH_REDIS_REST_URL\r\n  const upstashToken = process.env.UPSTASH_REDIS_REST_TOKEN\r\n  if (upstashUrl && upstashToken) {\r\n    const base = upstashUrl.replace(/\\/$/, '')\r\n    kvClient = {\r\n      async get(key: string) {\r\n        try {\r\n          const res = await fetch(`${base}/get/${encodeURIComponent(key)}`, {\r\n            headers: { Authorization: `Bearer ${upstashToken}` },\r\n          })\r\n          if (!res.ok) return null\r\n          const j = await res.json()\r\n          return j.result ?? null\r\n        } catch (err) {\r\n          console.error(\"[KV] get() failed:\", err)\r\n          return null\r\n        }\r\n      },\r\n      async set(key: string, value: any) {\r\n        if (NO_WRITE_FALLBACK) return { skippedReadOnly: true }\r\n        try {\r\n          // Upstash expects simple JSON with `value` field for the set endpoint\r\n          await fetch(`${base}/set/${encodeURIComponent(key)}`, {\r\n            method: 'POST',\r\n            headers: {\r\n              Authorization: `Bearer ${upstashToken}`,\r\n              'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({ value: typeof value === 'string' ? value : JSON.stringify(value) }),\r\n          })\r\n          return true\r\n        } catch (err) {\r\n          console.error(\"[KV] set() failed:\", err)\r\n          return null\r\n        }\r\n      },\r\n      async expire(key: string, ttl: number) {\r\n        if (NO_WRITE_FALLBACK) return null\r\n        try {\r\n          await fetch(`${base}/expire/${encodeURIComponent(key)}`, {\r\n            method: 'POST',\r\n            headers: {\r\n              Authorization: `Bearer ${upstashToken}`,\r\n              'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({ ttl }),\r\n          })\r\n          return true\r\n        } catch (err) {\r\n          console.error(\"[KV] expire() failed:\", err)\r\n          return null\r\n        }\r\n      },\r\n    }\r\n  } else {\r\n    kvClient = null\r\n  }\r\n}\r\n\r\nconst RDAP_TTL_SECONDS = 300\r\n\r\nexport async function kvGetRdap(domain: string) {\r\n  if (!kvClient) return null\r\n  try {\r\n    const key = `rdap:${domain.toLowerCase()}`\r\n    const value = await kvClient.get(key)\r\n    return value ?? null\r\n  } catch (e) {\r\n    return null\r\n  }\r\n}\r\n\r\nexport async function kvSetRdap(domain: string, value: any) {\r\n  if (!kvClient) return null\r\n  if (NO_WRITE_FALLBACK) return { skippedReadOnly: true }\r\n  try {\r\n    const key = `rdap:${domain.toLowerCase()}`\r\n    // @vercel/kv supports expire via .set with options in newer versions; use simple set\r\n    const setResult = await kvClient.set(key, value)\r\n    // If the client supports expiration, set TTL separately (best-effort)\r\n    try {\r\n      if (typeof kvClient.expire === 'function') await kvClient.expire(key, RDAP_TTL_SECONDS)\r\n    } catch (_) {\r\n      // ignore\r\n    }\r\n    return setResult\r\n  } catch (e) {\r\n    // fail silently\r\n    return null\r\n  }\r\n}\r\n\r\n// Lightweight generic KV helper (non-breaking addition).\r\n// Provides `kv.get(key)` and `kv.set(key, value, { ex })` to support debug routes.\r\nexport const kv = {\r\n  async get(key: string) {\r\n    if (!kvClient) return null\r\n    try {\r\n      const v = await kvClient.get(key)\r\n      // Normalize multiple possible shapes returned by different clients\r\n      //  - raw primitive (number/string)\r\n      //  - JSON string (\"{...}\")\r\n      //  - wrapped object like { value: \"...\" }\r\n      if (v === null || v === undefined) return null\r\n\r\n      let parsed: any = v\r\n      if (typeof v === 'string') {\r\n        try {\r\n          parsed = JSON.parse(v)\r\n        } catch (_) {\r\n          parsed = v\r\n        }\r\n      }\r\n\r\n      // If the stored value is wrapped as { value: \"...\" }, unwrap it.\r\n      if (parsed && typeof parsed === 'object' && 'value' in parsed) {\r\n        const inner = parsed.value\r\n        if (typeof inner === 'string') {\r\n          try {\r\n            return JSON.parse(inner)\r\n          } catch (_) {\r\n            return inner\r\n          }\r\n        }\r\n        return inner\r\n      }\r\n\r\n      return parsed\r\n    } catch (err) {\r\n      console.error(\"[KV] get() failed:\", err)\r\n      // If the underlying client failed due to an invalid/missing base URL,\r\n      // attempt a best-effort direct Upstash REST fallback using environment\r\n      // variables. This helps in child-process/test runtimes where the\r\n      // installed client was initialized with undefined env values.\r\n      try {\r\n        if (process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN) {\r\n          const base = (process.env.UPSTASH_REDIS_REST_URL || '').replace(/\\/$/, '')\r\n          const upstashToken = process.env.UPSTASH_REDIS_REST_TOKEN\r\n          const url = `${base}/get/${encodeURIComponent(key)}`\r\n          console.log('[KV] attempting Upstash REST fallback GET', url)\r\n          const res = await fetch(url, {\r\n            headers: { Authorization: `Bearer ${upstashToken}` },\r\n          })\r\n          console.log('[KV] upstash REST fallback status', res.status)\r\n          if (!res.ok) return null\r\n          const j = await res.json()\r\n          console.log('[KV] upstash REST fallback body keys', Object.keys(j || {}))\r\n          return j.result ?? null\r\n        }\r\n      } catch (fallbackErr) {\r\n        console.error('[KV] upstash REST fallback failed:', fallbackErr)\r\n      }\r\n      return null\r\n    }\r\n  },\r\n  async set(key: string, value: any, opts?: { ex?: number }) {\r\n    if (!kvClient) return null\r\n    if (NO_WRITE_FALLBACK) return { skippedReadOnly: true }\r\n    try {\r\n      // Avoid double-encoding: pass raw values to the underlying client and\r\n      // let that client (or our Upstash REST wrapper) handle any required\r\n      // encoding. This prevents nested JSON like \"{\\\"value\\\":\\\"1\\\"}\".\r\n      const setResult = await kvClient.set(key, value)\r\n      if (opts?.ex && typeof kvClient.expire === 'function') {\r\n        try {\r\n          await kvClient.expire(key, Math.ceil(opts.ex))\r\n        } catch (_) {\r\n          // ignore\r\n        }\r\n      }\r\n      return setResult\r\n    } catch (err) {\r\n      console.error(\"[KV] set() failed:\", err)\r\n      return null\r\n    }\r\n  },\r\n}\r\n\r\nexport default { kvGetRdap, kvSetRdap }\r\n\r\nexport function getKvStatus() {\r\n  return {\r\n    writeEnabled: WRITE_ENABLED,\r\n    readOnlyOnly: READ_ONLY_ONLY,\r\n    noWriteFallback: NO_WRITE_FALLBACK,\r\n    kvClientPresent: !!kvClient,\r\n    kvUrl: process.env.KV_REST_API_URL || process.env.UPSTASH_REDIS_REST_URL || null,\r\n  }\r\n}\r\n\r\n// Temporary debug helper — writes and reads a test key and logs results.\r\nexport async function debugKvRoundTrip() {\r\n  const key = \"debug:kv:test\"\r\n  const value = { ok: true, ts: Date.now() }\r\n  console.log(\"[KV] Writing test key:\", key)\r\n  const writeResult = await kv.set(key, JSON.stringify(value))\r\n  console.log(\"[KV] Write result:\", writeResult)\r\n  const readResult = await kv.get(key)\r\n  console.log(\"[KV] Read result:\", readResult)\r\n  return { writeResult, readResult }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA,kFAAkF;AAClF,yEAAyE;AACzE,8EAA8E;AAC9E,8CAA8C;AAC9C,IAAI,WAAgB;AACpB,+EAA+E;AAC/E,IAAI,gBAAgB;AACpB,IAAI,iBAAiB;AACrB,IAAI,oBAAoB;AAExB,IAAI;IACF,+EAA+E;IAC/E,wEAAwE;IACxE,2EAA2E;IAC3E,iEAAiE;IACjE,IAAI,CAAC,QAAQ,GAAG,CAAC,eAAe,EAAE;QAChC,QAAQ,GAAG,CAAC,eAAe,GAAG,QAAQ,GAAG,CAAC,sBAAsB,IAAI,QAAQ,GAAG,CAAC,eAAe;IACjG;IACA,IAAI,CAAC,QAAQ,GAAG,CAAC,iBAAiB,EAAE;QAClC,QAAQ,GAAG,CAAC,iBAAiB,GAAG,QAAQ,GAAG,CAAC,uBAAuB,IAAI,QAAQ,GAAG,CAAC,wBAAwB,IAAI,QAAQ,GAAG,CAAC,2BAA2B,IAAI,QAAQ,GAAG,CAAC,iBAAiB;IACzL;IAEA,uEAAuE;IACvE,oEAAoE;IACpE,gBAAgB,CAAC,CAAC,CAAC,QAAQ,GAAG,CAAC,uBAAuB,IAAI,QAAQ,GAAG,CAAC,iBAAiB;IACvF,iBAAiB,CAAC,CAAC,QAAQ,GAAG,CAAC,2BAA2B,IAAI,CAAC;IAC/D,oBAAoB,QAAQ,GAAG,CAAC,iBAAiB,KAAK,UAAU;IAEhE,0EAA0E;IAC1E,wEAAwE;IACxE,MAAM,kBAAkB,QAAQ,GAAG,CAAC,sBAAsB;IAC1D,MAAM,oBAAoB,QAAQ,GAAG,CAAC,wBAAwB;IAC9D,IAAI,mBAAmB,mBAAmB;QACxC,MAAM,OAAO,gBAAgB,OAAO,CAAC,OAAO;QAC5C,WAAW;YACT,MAAM,KAAI,GAAW;gBACnB,IAAI;oBACF,MAAM,MAAM,MAAM,MAAM,GAAG,KAAK,KAAK,EAAE,mBAAmB,MAAM,EAAE;wBAChE,SAAS;4BAAE,eAAe,CAAC,OAAO,EAAE,mBAAmB;wBAAC;oBAC1D;oBACA,IAAI,CAAC,IAAI,EAAE,EAAE,OAAO;oBACpB,MAAM,IAAI,MAAM,IAAI,IAAI;oBACxB,OAAO,EAAE,MAAM,IAAI;gBACrB,EAAE,OAAO,KAAK;oBACZ,QAAQ,KAAK,CAAC,iCAAiC;oBAC/C,OAAO;gBACT;YACF;YACA,MAAM,KAAI,GAAW,EAAE,KAAU;gBAC/B,IAAI,mBAAmB,OAAO;oBAAE,iBAAiB;gBAAK;gBACtD,IAAI;oBACF,MAAM,MAAM,GAAG,KAAK,KAAK,EAAE,mBAAmB,MAAM,EAAE;wBACpD,QAAQ;wBACR,SAAS;4BACP,eAAe,CAAC,OAAO,EAAE,mBAAmB;4BAC5C,gBAAgB;wBAClB;wBACA,MAAM,KAAK,SAAS,CAAC;4BAAE,OAAO,OAAO,UAAU,WAAW,QAAQ,KAAK,SAAS,CAAC;wBAAO;oBAC1F;oBACA,OAAO;gBACT,EAAE,OAAO,KAAK;oBACZ,QAAQ,KAAK,CAAC,iCAAiC;oBAC/C,OAAO;gBACT;YACF;YACA,MAAM,QAAO,GAAW,EAAE,GAAW;gBACnC,IAAI,mBAAmB,OAAO;gBAC9B,IAAI;oBACF,MAAM,MAAM,GAAG,KAAK,QAAQ,EAAE,mBAAmB,MAAM,EAAE;wBACvD,QAAQ;wBACR,SAAS;4BACP,eAAe,CAAC,OAAO,EAAE,mBAAmB;4BAC5C,gBAAgB;wBAClB;wBACA,MAAM,KAAK,SAAS,CAAC;4BAAE;wBAAI;oBAC7B;oBACA,OAAO;gBACT,EAAE,OAAO,KAAK;oBACZ,QAAQ,KAAK,CAAC,oCAAoC;oBAClD,OAAO;gBACT;YACF;QACF;IACF;IAEA,uEAAuE;IACvE,MAAM,aAAa,MAAM,WAAW;IACpC,iFAAiF;IACjF,8DAA8D;IAC9D,aAAa;IACb,MAAM,WAAW,KAAK,WAAW;IAEjC,oDAAoD;IACpD,IAAI,YAAiB,UAAU,MAAM,UAAU,WAAW;IAE1D,wEAAwE;IACxE,IAAI,OAAO,cAAc,YAAY;QACnC,wEAAwE;QACxE,uEAAuE;QACvE,6DAA6D;QAC7D,MAAM,UAAU;QAChB,MAAM,WAAW,CAAC;YAChB,IAAI,aAAkB;YACtB,IAAI,gBAAgB;YACpB,MAAM,SAAS;gBACb,IAAI,YAAY,OAAO;gBACvB,IAAI,eAAe,OAAO;gBAC1B,gBAAgB;gBAChB,IAAI;oBACF,MAAM,MAAM,QAAQ,GAAG,CAAC,eAAe,IAAI,QAAQ,GAAG,CAAC,sBAAsB;oBAC7E,MAAM,QAAQ,QAAQ,GAAG,CAAC,iBAAiB,IAAI,QAAQ,GAAG,CAAC,wBAAwB;oBACnF,aAAa,MAAM,UAAU;wBAAE;wBAAK;oBAAM;oBAC1C,IAAI,CAAC,CAAC,cAAc,OAAO,WAAW,GAAG,KAAK,cAAc,OAAO,WAAW,GAAG,KAAK,UAAU,GAAG;wBACjG,aAAa;oBACf;gBACF,EAAE,OAAO,KAAK;oBACZ,aAAa;gBACf;gBACA,OAAO;YACT;YACA,OAAO;gBACL,MAAM,KAAI,CAAS;oBACjB,MAAM,IAAI,MAAM;oBAChB,IAAI,CAAC,GAAG,MAAM,IAAI,MAAM;oBACxB,OAAO,EAAE,GAAG,CAAC;gBACf;gBACA,MAAM,KAAI,CAAS,EAAE,CAAM;oBACzB,MAAM,IAAI,MAAM;oBAChB,IAAI,CAAC,GAAG,MAAM,IAAI,MAAM;oBACxB,OAAO,EAAE,GAAG,CAAC,GAAG;gBAClB;gBACA,MAAM,QAAO,CAAS,EAAE,CAAS;oBAC/B,MAAM,IAAI,MAAM;oBAChB,IAAI,CAAC,GAAG,MAAM,IAAI,MAAM;oBACxB,IAAI,OAAO,EAAE,MAAM,KAAK,YAAY,OAAO,EAAE,MAAM,CAAC,GAAG;oBACvD,OAAO;gBACT;YACF;QACF;QAEA,IAAI;YACF,YAAY,SAAS;QACvB,EAAE,OAAO,KAAK;QACZ,4BAA4B;QAC9B;IACF;IAEA,0CAA0C;IAC1C,IAAI,aAAa,OAAO,UAAU,GAAG,KAAK,cAAc,OAAO,UAAU,GAAG,KAAK,YAAY;QAC3F,WAAW;IACb,OAAO;QACL,uEAAuE;QACvE,QAAQ,IAAI,CAAC,mEAAmE,OAAO,IAAI,CAAC,YAAY,CAAC;QACzG,MAAM,IAAI,MAAM;IAClB;AACF,EAAE,OAAO,GAAG;IACV,qEAAqE;IACrE,uEAAuE;IACvE,MAAM,aAAa,QAAQ,GAAG,CAAC,sBAAsB;IACrD,MAAM,eAAe,QAAQ,GAAG,CAAC,wBAAwB;IACzD,IAAI,cAAc,cAAc;QAC9B,MAAM,OAAO,WAAW,OAAO,CAAC,OAAO;QACvC,WAAW;YACT,MAAM,KAAI,GAAW;gBACnB,IAAI;oBACF,MAAM,MAAM,MAAM,MAAM,GAAG,KAAK,KAAK,EAAE,mBAAmB,MAAM,EAAE;wBAChE,SAAS;4BAAE,eAAe,CAAC,OAAO,EAAE,cAAc;wBAAC;oBACrD;oBACA,IAAI,CAAC,IAAI,EAAE,EAAE,OAAO;oBACpB,MAAM,IAAI,MAAM,IAAI,IAAI;oBACxB,OAAO,EAAE,MAAM,IAAI;gBACrB,EAAE,OAAO,KAAK;oBACZ,QAAQ,KAAK,CAAC,sBAAsB;oBACpC,OAAO;gBACT;YACF;YACA,MAAM,KAAI,GAAW,EAAE,KAAU;gBAC/B,IAAI,mBAAmB,OAAO;oBAAE,iBAAiB;gBAAK;gBACtD,IAAI;oBACF,sEAAsE;oBACtE,MAAM,MAAM,GAAG,KAAK,KAAK,EAAE,mBAAmB,MAAM,EAAE;wBACpD,QAAQ;wBACR,SAAS;4BACP,eAAe,CAAC,OAAO,EAAE,cAAc;4BACvC,gBAAgB;wBAClB;wBACA,MAAM,KAAK,SAAS,CAAC;4BAAE,OAAO,OAAO,UAAU,WAAW,QAAQ,KAAK,SAAS,CAAC;wBAAO;oBAC1F;oBACA,OAAO;gBACT,EAAE,OAAO,KAAK;oBACZ,QAAQ,KAAK,CAAC,sBAAsB;oBACpC,OAAO;gBACT;YACF;YACA,MAAM,QAAO,GAAW,EAAE,GAAW;gBACnC,IAAI,mBAAmB,OAAO;gBAC9B,IAAI;oBACF,MAAM,MAAM,GAAG,KAAK,QAAQ,EAAE,mBAAmB,MAAM,EAAE;wBACvD,QAAQ;wBACR,SAAS;4BACP,eAAe,CAAC,OAAO,EAAE,cAAc;4BACvC,gBAAgB;wBAClB;wBACA,MAAM,KAAK,SAAS,CAAC;4BAAE;wBAAI;oBAC7B;oBACA,OAAO;gBACT,EAAE,OAAO,KAAK;oBACZ,QAAQ,KAAK,CAAC,yBAAyB;oBACvC,OAAO;gBACT;YACF;QACF;IACF,OAAO;QACL,WAAW;IACb;AACF;AAEA,MAAM,mBAAmB;AAElB,eAAe,UAAU,MAAc;IAC5C,IAAI,CAAC,UAAU,OAAO;IACtB,IAAI;QACF,MAAM,MAAM,CAAC,KAAK,EAAE,OAAO,WAAW,IAAI;QAC1C,MAAM,QAAQ,MAAM,SAAS,GAAG,CAAC;QACjC,OAAO,SAAS;IAClB,EAAE,OAAO,GAAG;QACV,OAAO;IACT;AACF;AAEO,eAAe,UAAU,MAAc,EAAE,KAAU;IACxD,IAAI,CAAC,UAAU,OAAO;IACtB,IAAI,mBAAmB,OAAO;QAAE,iBAAiB;IAAK;IACtD,IAAI;QACF,MAAM,MAAM,CAAC,KAAK,EAAE,OAAO,WAAW,IAAI;QAC1C,qFAAqF;QACrF,MAAM,YAAY,MAAM,SAAS,GAAG,CAAC,KAAK;QAC1C,sEAAsE;QACtE,IAAI;YACF,IAAI,OAAO,SAAS,MAAM,KAAK,YAAY,MAAM,SAAS,MAAM,CAAC,KAAK;QACxE,EAAE,OAAO,GAAG;QACV,SAAS;QACX;QACA,OAAO;IACT,EAAE,OAAO,GAAG;QACV,gBAAgB;QAChB,OAAO;IACT;AACF;AAIO,MAAM,KAAK;IAChB,MAAM,KAAI,GAAW;QACnB,IAAI,CAAC,UAAU,OAAO;QACtB,IAAI;YACF,MAAM,IAAI,MAAM,SAAS,GAAG,CAAC;YAC7B,mEAAmE;YACnE,mCAAmC;YACnC,2BAA2B;YAC3B,0CAA0C;YAC1C,IAAI,MAAM,QAAQ,MAAM,WAAW,OAAO;YAE1C,IAAI,SAAc;YAClB,IAAI,OAAO,MAAM,UAAU;gBACzB,IAAI;oBACF,SAAS,KAAK,KAAK,CAAC;gBACtB,EAAE,OAAO,GAAG;oBACV,SAAS;gBACX;YACF;YAEA,iEAAiE;YACjE,IAAI,UAAU,OAAO,WAAW,YAAY,WAAW,QAAQ;gBAC7D,MAAM,QAAQ,OAAO,KAAK;gBAC1B,IAAI,OAAO,UAAU,UAAU;oBAC7B,IAAI;wBACF,OAAO,KAAK,KAAK,CAAC;oBACpB,EAAE,OAAO,GAAG;wBACV,OAAO;oBACT;gBACF;gBACA,OAAO;YACT;YAEA,OAAO;QACT,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,sBAAsB;YACpC,sEAAsE;YACtE,uEAAuE;YACvE,iEAAiE;YACjE,8DAA8D;YAC9D,IAAI;gBACF,IAAI,QAAQ,GAAG,CAAC,sBAAsB,IAAI,QAAQ,GAAG,CAAC,wBAAwB,EAAE;oBAC9E,MAAM,OAAO,CAAC,QAAQ,GAAG,CAAC,sBAAsB,IAAI,EAAE,EAAE,OAAO,CAAC,OAAO;oBACvE,MAAM,eAAe,QAAQ,GAAG,CAAC,wBAAwB;oBACzD,MAAM,MAAM,GAAG,KAAK,KAAK,EAAE,mBAAmB,MAAM;oBACpD,QAAQ,GAAG,CAAC,6CAA6C;oBACzD,MAAM,MAAM,MAAM,MAAM,KAAK;wBAC3B,SAAS;4BAAE,eAAe,CAAC,OAAO,EAAE,cAAc;wBAAC;oBACrD;oBACA,QAAQ,GAAG,CAAC,qCAAqC,IAAI,MAAM;oBAC3D,IAAI,CAAC,IAAI,EAAE,EAAE,OAAO;oBACpB,MAAM,IAAI,MAAM,IAAI,IAAI;oBACxB,QAAQ,GAAG,CAAC,wCAAwC,OAAO,IAAI,CAAC,KAAK,CAAC;oBACtE,OAAO,EAAE,MAAM,IAAI;gBACrB;YACF,EAAE,OAAO,aAAa;gBACpB,QAAQ,KAAK,CAAC,sCAAsC;YACtD;YACA,OAAO;QACT;IACF;IACA,MAAM,KAAI,GAAW,EAAE,KAAU,EAAE,IAAsB;QACvD,IAAI,CAAC,UAAU,OAAO;QACtB,IAAI,mBAAmB,OAAO;YAAE,iBAAiB;QAAK;QACtD,IAAI;YACF,sEAAsE;YACtE,oEAAoE;YACpE,gEAAgE;YAChE,MAAM,YAAY,MAAM,SAAS,GAAG,CAAC,KAAK;YAC1C,IAAI,MAAM,MAAM,OAAO,SAAS,MAAM,KAAK,YAAY;gBACrD,IAAI;oBACF,MAAM,SAAS,MAAM,CAAC,KAAK,KAAK,IAAI,CAAC,KAAK,EAAE;gBAC9C,EAAE,OAAO,GAAG;gBACV,SAAS;gBACX;YACF;YACA,OAAO;QACT,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,sBAAsB;YACpC,OAAO;QACT;IACF;AACF;uCAEe;IAAE;IAAW;AAAU;AAE/B,SAAS;IACd,OAAO;QACL,cAAc;QACd,cAAc;QACd,iBAAiB;QACjB,iBAAiB,CAAC,CAAC;QACnB,OAAO,QAAQ,GAAG,CAAC,eAAe,IAAI,QAAQ,GAAG,CAAC,sBAAsB,IAAI;IAC9E;AACF;AAGO,eAAe;IACpB,MAAM,MAAM;IACZ,MAAM,QAAQ;QAAE,IAAI;QAAM,IAAI,KAAK,GAAG;IAAG;IACzC,QAAQ,GAAG,CAAC,0BAA0B;IACtC,MAAM,cAAc,MAAM,GAAG,GAAG,CAAC,KAAK,KAAK,SAAS,CAAC;IACrD,QAAQ,GAAG,CAAC,sBAAsB;IAClC,MAAM,aAAa,MAAM,GAAG,GAAG,CAAC;IAChC,QAAQ,GAAG,CAAC,qBAAqB;IACjC,OAAO;QAAE;QAAa;IAAW;AACnC"}},
    {"offset": {"line": 436, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai/src/lib/builder/load.ts"],"sourcesContent":["import { kv } from \"@/lib/kv\";\r\nimport type { BuilderState } from \"@/types/builder\";\r\n\r\nconst KEY_PREFIX = \"buildwithai:site:\";\r\n\r\nexport async function loadSiteState(\r\n  siteId: string\r\n): Promise<BuilderState | null> {\r\n  const key = `${KEY_PREFIX}${siteId}`;\r\n  const raw = await kv.get(key);\r\n  if (!raw) return null;\r\n\r\n  // `kv.get` may return a parsed object or a JSON string depending on the\r\n  // underlying client. Normalize to an object safely.\r\n  let parsed: any = raw;\r\n  if (typeof raw === \"string\") {\r\n    try {\r\n      parsed = JSON.parse(raw);\r\n    } catch {\r\n      // If parsing fails, treat as missing/invalid\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Validate minimal schema\r\n  if (!parsed || typeof parsed !== \"object\") return null;\r\n  if (!parsed.metadata || !parsed.pages) return null;\r\n\r\n  // Ensure metadata fields exist\r\n  parsed.metadata = {\r\n    id: parsed.metadata.id ?? siteId,\r\n    name: parsed.metadata.name ?? \"\",\r\n    description: parsed.metadata.description ?? \"\",\r\n    createdAt: parsed.metadata.createdAt ?? Date.now(),\r\n    updatedAt: parsed.metadata.updatedAt ?? Date.now(),\r\n    version: parsed.metadata.version ?? 1,\r\n  };\r\n\r\n  // Ensure pages array exists\r\n  if (!Array.isArray(parsed.pages)) parsed.pages = [];\r\n\r\n  return parsed as BuilderState;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAGA,MAAM,aAAa;AAEZ,eAAe,cACpB,MAAc;IAEd,MAAM,MAAM,GAAG,aAAa,QAAQ;IACpC,MAAM,MAAM,MAAM,uIAAE,CAAC,GAAG,CAAC;IACzB,IAAI,CAAC,KAAK,OAAO;IAEjB,wEAAwE;IACxE,oDAAoD;IACpD,IAAI,SAAc;IAClB,IAAI,OAAO,QAAQ,UAAU;QAC3B,IAAI;YACF,SAAS,KAAK,KAAK,CAAC;QACtB,EAAE,OAAM;YACN,6CAA6C;YAC7C,OAAO;QACT;IACF;IAEA,0BAA0B;IAC1B,IAAI,CAAC,UAAU,OAAO,WAAW,UAAU,OAAO;IAClD,IAAI,CAAC,OAAO,QAAQ,IAAI,CAAC,OAAO,KAAK,EAAE,OAAO;IAE9C,+BAA+B;IAC/B,OAAO,QAAQ,GAAG;QAChB,IAAI,OAAO,QAAQ,CAAC,EAAE,IAAI;QAC1B,MAAM,OAAO,QAAQ,CAAC,IAAI,IAAI;QAC9B,aAAa,OAAO,QAAQ,CAAC,WAAW,IAAI;QAC5C,WAAW,OAAO,QAAQ,CAAC,SAAS,IAAI,KAAK,GAAG;QAChD,WAAW,OAAO,QAAQ,CAAC,SAAS,IAAI,KAAK,GAAG;QAChD,SAAS,OAAO,QAAQ,CAAC,OAAO,IAAI;IACtC;IAEA,4BAA4B;IAC5B,IAAI,CAAC,MAAM,OAAO,CAAC,OAAO,KAAK,GAAG,OAAO,KAAK,GAAG,EAAE;IAEnD,OAAO;AACT"}},
    {"offset": {"line": 478, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai/src/lib/export/site.ts"],"sourcesContent":["import type { BuilderState, BuilderBlock } from \"@/types/builder\";\r\n\r\nexport type ExportedSite = {\r\n  html: string;\r\n  css: string;\r\n  head: string;\r\n};\r\n\r\nfunction renderBlock(block: BuilderBlock): string {\r\n  const data = block.data ?? {};\r\n\r\n  switch (block.type) {\r\n    case \"hero\": {\r\n      const heading = data.heading ?? \"Welcome to your new site\";\r\n      const subheading =\r\n        data.subheading ??\r\n        \"This page was generated with Build With AI.\";\r\n      const ctaLabel = data.ctaLabel ?? \"Get started\";\r\n      return `\r\n<section class=\"hero\">\r\n  <div class=\"container\">\r\n    <h1>${heading}</h1>\r\n    <p>${subheading}</p>\r\n    <a href=\"#contact\" class=\"btn-primary\">${ctaLabel}</a>\r\n  </div>\r\n</section>`;\r\n    }\r\n\r\n    case \"features\": {\r\n      const title = data.title ?? \"Features\";\r\n      const items: Array<{ title: string; description: string }> =\r\n        data.items ?? [];\r\n      const list = items\r\n        .map(\r\n          (item) => `\r\n  <div class=\"feature\">\r\n    <h3>${item.title}</h3>\r\n    <p>${item.description}</p>\r\n  </div>`\r\n        )\r\n        .join(\"\\n\");\r\n      return `\r\n<section class=\"features\">\r\n  <div class=\"container\">\r\n    <h2>${title}</h2>\r\n    <div class=\"feature-grid\">\r\n      ${list}\r\n    </div>\r\n  </div>\r\n</section>`;\r\n    }\r\n\r\n    case \"testimonials\": {\r\n      const title = data.title ?? \"What people are saying\";\r\n      const items: Array<{ quote: string; name: string }> =\r\n        data.items ?? [];\r\n      const list = items\r\n        .map(\r\n          (item) => `\r\n  <div class=\"testimonial\">\r\n    <blockquote>“${item.quote}”</blockquote>\r\n    <p class=\"name\">${item.name}</p>\r\n  </div>`\r\n        )\r\n        .join(\"\\n\");\r\n      return `\r\n<section class=\"testimonials\">\r\n  <div class=\"container\">\r\n    <h2>${title}</h2>\r\n    <div class=\"testimonial-grid\">\r\n      ${list}\r\n    </div>\r\n  </div>\r\n</section>`;\r\n    }\r\n\r\n    case \"faq\": {\r\n      const title = data.title ?? \"Frequently asked questions\";\r\n      const items: Array<{ question: string; answer: string }> =\r\n        data.items ?? [];\r\n      const list = items\r\n        .map(\r\n          (item) => `\r\n  <div class=\"faq-item\">\r\n    <h3>${item.question}</h3>\r\n    <p>${item.answer}</p>\r\n  </div>`\r\n        )\r\n        .join(\"\\n\");\r\n      return `\r\n<section class=\"faq\">\r\n  <div class=\"container\">\r\n    <h2>${title}</h2>\r\n    <div class=\"faq-list\">\r\n      ${list}\r\n    </div>\r\n  </div>\r\n</section>`;\r\n    }\r\n\r\n    case \"cta\": {\r\n      const heading = data.heading ?? \"Ready to begin?\";\r\n      const subheading =\r\n        data.subheading ?? \"Take the next step with your new site.\";\r\n      const ctaLabel = data.ctaLabel ?? \"Contact us\";\r\n      return `\r\n<section class=\"cta\">\r\n  <div class=\"container\">\r\n    <h2>${heading}</h2>\r\n    <p>${subheading}</p>\r\n    <a href=\"#contact\" class=\"btn-primary\">${ctaLabel}</a>\r\n  </div>\r\n</section>`;\r\n    }\r\n\r\n    default: {\r\n      return `\r\n<section class=\"unknown\">\r\n  <div class=\"container\">\r\n    <p>Unsupported block type: ${block.type}</p>\r\n  </div>\r\n</section>`;\r\n    }\r\n  }\r\n}\r\n\r\nexport function exportSiteToStatic(state: BuilderState): ExportedSite {\r\n  const title = state.metadata.name || \"Build With AI site\";\r\n  const description =\r\n    state.metadata.description ||\r\n    \"A site generated with Build With AI.\";\r\n\r\n  const blocksHtml = (state.pages[0]?.blocks ?? [])\r\n    .map((block) => renderBlock(block))\r\n    .join(\"\\n\\n\");\r\n\r\n  const html = `<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n  <meta charset=\"UTF-8\" />\r\n  <title>${title}</title>\r\n  <meta name=\"description\" content=\"${description}\" />\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\r\n  {{HEAD}}\r\n</head>\r\n<body>\r\n  <main>\r\n    ${blocksHtml}\r\n  </main>\r\n</body>\r\n</html>`;\r\n\r\n  const css = `\r\n:root {\r\n  --bg: #0f172a;\r\n  --fg: #ffffff;\r\n  --accent: #22c55e;\r\n  --muted: #94a3b8;\r\n}\r\n\r\n*,\r\n*::before,\r\n*::after {\r\n  box-sizing: border-box;\r\n}\r\n\r\nbody {\r\n  margin: 0;\r\n  font-family: system-ui, -apple-system, BlinkMacSystemFont, \"SF Pro Text\",\r\n    \"Inter\", sans-serif;\r\n  background: var(--bg);\r\n  color: var(--fg);\r\n}\r\n\r\nmain {\r\n  padding: 40px 0 80px;\r\n}\r\n\r\n.container {\r\n  width: 100%;\r\n  max-width: 960px;\r\n  margin: 0 auto;\r\n  padding: 0 20px;\r\n}\r\n\r\n.hero {\r\n  padding: 80px 0 60px;\r\n}\r\n\r\n.hero h1 {\r\n  font-size: 2.75rem;\r\n  line-height: 1.1;\r\n  margin-bottom: 16px;\r\n}\r\n\r\n.hero p {\r\n  font-size: 1.1rem;\r\n  color: var(--muted);\r\n  max-width: 600px;\r\n}\r\n\r\n.btn-primary {\r\n  display: inline-block;\r\n  margin-top: 24px;\r\n  padding: 10px 18px;\r\n  border-radius: 999px;\r\n  background: var(--accent);\r\n  color: #020617;\r\n  font-weight: 600;\r\n  font-size: 0.95rem;\r\n  text-decoration: none;\r\n}\r\n\r\n.features,\r\n.testimonials,\r\n.faq,\r\n.cta {\r\n  padding: 40px 0;\r\n}\r\n\r\n.features h2,\r\n.testimonials h2,\r\n.faq h2,\r\n.cta h2 {\r\n  font-size: 1.6rem;\r\n  margin-bottom: 16px;\r\n}\r\n\r\n.feature-grid,\r\n.testimonial-grid {\r\n  display: grid;\r\n  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));\r\n  gap: 16px;\r\n  margin-top: 16px;\r\n}\r\n\r\n.feature,\r\n.testimonial,\r\n.faq-item {\r\n  padding: 14px 16px;\r\n  border-radius: 12px;\r\n  background: rgba(15, 23, 42, 0.9);\r\n  border: 1px solid rgba(148, 163, 184, 0.3);\r\n}\r\n\r\n.feature h3,\r\n.faq-item h3 {\r\n  margin: 0 0 8px;\r\n  font-size: 1rem;\r\n}\r\n\r\n.feature p,\r\n.faq-item p {\r\n  margin: 0;\r\n  font-size: 0.9rem;\r\n  color: var(--muted);\r\n}\r\n\r\n.testimonial blockquote {\r\n  margin: 0 0 8px;\r\n  font-size: 0.95rem;\r\n}\r\n\r\n.testimonial .name {\r\n  margin: 0;\r\n  font-size: 0.85rem;\r\n  color: var(--muted);\r\n}\r\n\r\n.cta p {\r\n  margin-top: 8px;\r\n  color: var(--muted);\r\n}\r\n\r\n.unknown {\r\n  padding: 20px 0;\r\n}\r\n\r\n.unknown p {\r\n  font-size: 0.85rem;\r\n  color: var(--muted);\r\n}\r\n`;\r\n\r\n  const head = `\r\n<link rel=\"stylesheet\" href=\"/styles.css\" />\r\n<meta property=\"og:title\" content=\"${title}\" />\r\n<meta property=\"og:description\" content=\"${description}\" />\r\n`;\r\n\r\n  return {\r\n    html: html.replace(\"{{HEAD}}\", head),\r\n    css,\r\n    head,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAQA,SAAS,YAAY,KAAmB;IACtC,MAAM,OAAO,MAAM,IAAI,IAAI,CAAC;IAE5B,OAAQ,MAAM,IAAI;QAChB,KAAK;YAAQ;gBACX,MAAM,UAAU,KAAK,OAAO,IAAI;gBAChC,MAAM,aACJ,KAAK,UAAU,IACf;gBACF,MAAM,WAAW,KAAK,QAAQ,IAAI;gBAClC,OAAO,CAAC;;;QAGN,EAAE,QAAQ;OACX,EAAE,WAAW;2CACuB,EAAE,SAAS;;UAE5C,CAAC;YACP;QAEA,KAAK;YAAY;gBACf,MAAM,QAAQ,KAAK,KAAK,IAAI;gBAC5B,MAAM,QACJ,KAAK,KAAK,IAAI,EAAE;gBAClB,MAAM,OAAO,MACV,GAAG,CACF,CAAC,OAAS,CAAC;;QAEb,EAAE,KAAK,KAAK,CAAC;OACd,EAAE,KAAK,WAAW,CAAC;QAClB,CAAC,EAEA,IAAI,CAAC;gBACR,OAAO,CAAC;;;QAGN,EAAE,MAAM;;MAEV,EAAE,KAAK;;;UAGH,CAAC;YACP;QAEA,KAAK;YAAgB;gBACnB,MAAM,QAAQ,KAAK,KAAK,IAAI;gBAC5B,MAAM,QACJ,KAAK,KAAK,IAAI,EAAE;gBAClB,MAAM,OAAO,MACV,GAAG,CACF,CAAC,OAAS,CAAC;;iBAEJ,EAAE,KAAK,KAAK,CAAC;oBACV,EAAE,KAAK,IAAI,CAAC;QACxB,CAAC,EAEA,IAAI,CAAC;gBACR,OAAO,CAAC;;;QAGN,EAAE,MAAM;;MAEV,EAAE,KAAK;;;UAGH,CAAC;YACP;QAEA,KAAK;YAAO;gBACV,MAAM,QAAQ,KAAK,KAAK,IAAI;gBAC5B,MAAM,QACJ,KAAK,KAAK,IAAI,EAAE;gBAClB,MAAM,OAAO,MACV,GAAG,CACF,CAAC,OAAS,CAAC;;QAEb,EAAE,KAAK,QAAQ,CAAC;OACjB,EAAE,KAAK,MAAM,CAAC;QACb,CAAC,EAEA,IAAI,CAAC;gBACR,OAAO,CAAC;;;QAGN,EAAE,MAAM;;MAEV,EAAE,KAAK;;;UAGH,CAAC;YACP;QAEA,KAAK;YAAO;gBACV,MAAM,UAAU,KAAK,OAAO,IAAI;gBAChC,MAAM,aACJ,KAAK,UAAU,IAAI;gBACrB,MAAM,WAAW,KAAK,QAAQ,IAAI;gBAClC,OAAO,CAAC;;;QAGN,EAAE,QAAQ;OACX,EAAE,WAAW;2CACuB,EAAE,SAAS;;UAE5C,CAAC;YACP;QAEA;YAAS;gBACP,OAAO,CAAC;;;+BAGiB,EAAE,MAAM,IAAI,CAAC;;UAElC,CAAC;YACP;IACF;AACF;AAEO,SAAS,mBAAmB,KAAmB;IACpD,MAAM,QAAQ,MAAM,QAAQ,CAAC,IAAI,IAAI;IACrC,MAAM,cACJ,MAAM,QAAQ,CAAC,WAAW,IAC1B;IAEF,MAAM,aAAa,CAAC,MAAM,KAAK,CAAC,EAAE,EAAE,UAAU,EAAE,EAC7C,GAAG,CAAC,CAAC,QAAU,YAAY,QAC3B,IAAI,CAAC;IAER,MAAM,OAAO,CAAC;;;;SAIP,EAAE,MAAM;oCACmB,EAAE,YAAY;;;;;;IAM9C,EAAE,WAAW;;;OAGV,CAAC;IAEN,MAAM,MAAM,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAkIf,CAAC;IAEC,MAAM,OAAO,CAAC;;mCAEmB,EAAE,MAAM;yCACF,EAAE,YAAY;AACvD,CAAC;IAEC,OAAO;QACL,MAAM,KAAK,OAAO,CAAC,YAAY;QAC/B;QACA;IACF;AACF"}},
    {"offset": {"line": 746, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai/src/lib/publisher/inject-tracking.ts"],"sourcesContent":["// src/lib/publisher/inject-tracking.ts\r\n\r\n/**\r\n * Injects analytics tracking into final published HTML.\r\n *\r\n * Adds:\r\n *   <script>window.__SITE_ID__ = \"...\"</script>\r\n *   <script src=\"/track.js\"></script>\r\n *\r\n * Injected before </head> if possible, otherwise at the top of <body>.\r\n */\r\nexport function injectTracking(html: string, siteId: string): string {\r\n  const siteIdScript = `<script>window.__SITE_ID__ = \"${siteId}\"</script>`;\r\n  const trackerScript = `<script src=\"/track.js\"></script>`;\r\n\r\n  const injection = `${siteIdScript}\\n${trackerScript}`;\r\n\r\n  // Prefer injecting before </head>\r\n  if (html.includes(\"</head>\")) {\r\n    return html.replace(\"</head>\", `${injection}\\n</head>`);\r\n  }\r\n\r\n  // Fallback: inject at top of <body>\r\n  if (html.includes(\"<body\")) {\r\n    return html.replace(/<body(.*?)>/i, (m) => `${m}\\n${injection}`);\r\n  }\r\n\r\n  // Last resort: prepend\r\n  return `${injection}\\n${html}`;\r\n}\r\n"],"names":[],"mappings":"AAAA,uCAAuC;AAEvC;;;;;;;;CAQC;;;;AACM,SAAS,eAAe,IAAY,EAAE,MAAc;IACzD,MAAM,eAAe,CAAC,8BAA8B,EAAE,OAAO,UAAU,CAAC;IACxE,MAAM,gBAAgB,CAAC,iCAAiC,CAAC;IAEzD,MAAM,YAAY,GAAG,aAAa,EAAE,EAAE,eAAe;IAErD,kCAAkC;IAClC,IAAI,KAAK,QAAQ,CAAC,YAAY;QAC5B,OAAO,KAAK,OAAO,CAAC,WAAW,GAAG,UAAU,SAAS,CAAC;IACxD;IAEA,oCAAoC;IACpC,IAAI,KAAK,QAAQ,CAAC,UAAU;QAC1B,OAAO,KAAK,OAAO,CAAC,gBAAgB,CAAC,IAAM,GAAG,EAAE,EAAE,EAAE,WAAW;IACjE;IAEA,uBAAuB;IACvB,OAAO,GAAG,UAAU,EAAE,EAAE,MAAM;AAChC"}},
    {"offset": {"line": 778, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai/src/lib/publisher/validate-tracking.ts"],"sourcesContent":["// src/lib/publisher/validate-tracking.ts\r\n\r\n/**\r\n * Very small validation to assert the injected tracking appears in HTML.\r\n */\r\nexport function validateTracking(html: string): boolean {\r\n  if (!html) return false;\r\n  const hasSiteId = /window\\.__SITE_ID__\\s*=/.test(html);\r\n  const hasTracker = /<script[^>]+src=[\"']\\/track\\.js[\"'][^>]*>\\s*<\\/script>/.test(html);\r\n  return Boolean(hasSiteId && hasTracker);\r\n}\r\n"],"names":[],"mappings":"AAAA,yCAAyC;AAEzC;;CAEC;;;;AACM,SAAS,iBAAiB,IAAY;IAC3C,IAAI,CAAC,MAAM,OAAO;IAClB,MAAM,YAAY,0BAA0B,IAAI,CAAC;IACjD,MAAM,aAAa,yDAAyD,IAAI,CAAC;IACjF,OAAO,QAAQ,aAAa;AAC9B"}},
    {"offset": {"line": 795, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai/src/lib/publish/vercel.ts"],"sourcesContent":["import { ExportedSite } from \"@/lib/export/site\";\r\nimport type { PublishResult } from \"@/types/publish\";\r\n\r\nconst HOOK_ENV_KEY = \"VERCEL_DEPLOY_HOOK_URL\";\r\n\r\nexport async function triggerVercelDeploy(\r\n  siteId: string,\r\n  _exported: ExportedSite\r\n): Promise<PublishResult> {\r\n  const hookUrl = process.env[HOOK_ENV_KEY];\r\n\r\n  if (!hookUrl) {\r\n    return {\r\n      ok: false,\r\n      error: `Missing ${HOOK_ENV_KEY} environment variable`,\r\n    };\r\n  }\r\n\r\n  try {\r\n    const res = await fetch(hookUrl, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      // Many Vercel deploy hooks ignore the body, but we include siteId for debugging.\r\n      body: JSON.stringify({\r\n        source: \"buildwithai\",\r\n        siteId,\r\n      }),\r\n    });\r\n\r\n    if (!res.ok) {\r\n      return {\r\n        ok: false,\r\n        error: `Vercel deploy hook failed with status ${res.status}`,\r\n      };\r\n    }\r\n\r\n    return {\r\n      ok: true,\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      ok: false,\r\n      error: error?.message ?? \"Unknown error triggering Vercel deploy\",\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAGA,MAAM,eAAe;AAEd,eAAe,oBACpB,MAAc,EACd,SAAuB;IAEvB,MAAM,UAAU,QAAQ,GAAG,CAAC,aAAa;IAEzC,IAAI,CAAC,SAAS;QACZ,OAAO;YACL,IAAI;YACJ,OAAO,CAAC,QAAQ,EAAE,aAAa,qBAAqB,CAAC;QACvD;IACF;IAEA,IAAI;QACF,MAAM,MAAM,MAAM,MAAM,SAAS;YAC/B,QAAQ;YACR,SAAS;gBACP,gBAAgB;YAClB;YACA,iFAAiF;YACjF,MAAM,KAAK,SAAS,CAAC;gBACnB,QAAQ;gBACR;YACF;QACF;QAEA,IAAI,CAAC,IAAI,EAAE,EAAE;YACX,OAAO;gBACL,IAAI;gBACJ,OAAO,CAAC,sCAAsC,EAAE,IAAI,MAAM,EAAE;YAC9D;QACF;QAEA,OAAO;YACL,IAAI;QACN;IACF,EAAE,OAAO,OAAY;QACnB,OAAO;YACL,IAAI;YACJ,OAAO,OAAO,WAAW;QAC3B;IACF;AACF"}},
    {"offset": {"line": 840, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai/src/lib/ai/changelog.ts"],"sourcesContent":["import type { VersionSnapshot } from \"@/types/publish\";\r\n\r\nconst OLLAMA_ENDPOINT =\r\n  process.env.OLLAMA_ENDPOINT || \"http://localhost:11434\";\r\nconst OLLAMA_MODEL = process.env.OLLAMA_MODEL || \"llama3\";\r\n\r\ntype ChangelogInput = {\r\n  previous?: VersionSnapshot | null;\r\n  current: VersionSnapshot;\r\n};\r\n\r\nfunction buildPrompt(input: ChangelogInput): string {\r\n  const { previous, current } = input;\r\n\r\n  const prevVersion = previous?.version ?? null;\r\n  const prevState = previous?.state ?? null;\r\n  const currentVersion = current.version;\r\n  const currentState = current.state;\r\n\r\n  return `\r\nYou are an assistant that writes concise, human-readable changelogs for a website builder.\r\n\r\nYou will be given two JSON states:\r\n- \"previous\" (may be null)\r\n- \"current\"\r\n\r\nEach state represents the full builder state of a site in a \"Build With AI\" platform.\r\n\r\nYour job is to describe what changed between \"previous\" and \"current\" in clear, plain language, focusing on:\r\n- New sections or blocks added\r\n- Sections or blocks removed\r\n- Text changes in key headings, subheadings, and CTAs\r\n- Notable layout or content reorganizations\r\n- Any high-level structural changes\r\n\r\nIf there is no previous state, write a changelog as if this is the first published version of the site.\r\n\r\nReturn:\r\n- 2–5 short bullet points\r\n- No markdown bullet characters (just start each line with \"- \")\r\n\r\nPrevious (version: ${prevVersion ?? \"none\"}):\r\n${JSON.stringify(prevState, null, 2)}\r\n\r\nCurrent (version: ${currentVersion}):\r\n${JSON.stringify(currentState, null, 2)}\r\n`;\r\n}\r\n\r\nexport async function generateChangelogWithOllama(\r\n  input: ChangelogInput\r\n): Promise<string | null> {\r\n  try {\r\n    const prompt = buildPrompt(input);\r\n\r\n    const res = await fetch(`${OLLAMA_ENDPOINT}/api/generate`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        model: OLLAMA_MODEL,\r\n        prompt,\r\n        stream: false,\r\n      }),\r\n    });\r\n\r\n    if (!res.ok) {\r\n      console.error(\r\n        \"[changelog] Ollama request failed with status\",\r\n        res.status\r\n      );\r\n      return null;\r\n    }\r\n\r\n    const data = await res.json().catch(() => null);\r\n    const text = data?.response ?? data?.text ?? null;\r\n\r\n    if (!text || typeof text !== \"string\") {\r\n      return null;\r\n    }\r\n\r\n    return text.trim();\r\n  } catch (error) {\r\n    console.error(\"[changelog] Ollama error\", error);\r\n    return null;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAEA,MAAM,kBACJ,QAAQ,GAAG,CAAC,eAAe,IAAI;AACjC,MAAM,eAAe,QAAQ,GAAG,CAAC,YAAY,IAAI;AAOjD,SAAS,YAAY,KAAqB;IACxC,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,GAAG;IAE9B,MAAM,cAAc,UAAU,WAAW;IACzC,MAAM,YAAY,UAAU,SAAS;IACrC,MAAM,iBAAiB,QAAQ,OAAO;IACtC,MAAM,eAAe,QAAQ,KAAK;IAElC,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;mBAsBS,EAAE,eAAe,OAAO;AAC3C,EAAE,KAAK,SAAS,CAAC,WAAW,MAAM,GAAG;;kBAEnB,EAAE,eAAe;AACnC,EAAE,KAAK,SAAS,CAAC,cAAc,MAAM,GAAG;AACxC,CAAC;AACD;AAEO,eAAe,4BACpB,KAAqB;IAErB,IAAI;QACF,MAAM,SAAS,YAAY;QAE3B,MAAM,MAAM,MAAM,MAAM,GAAG,gBAAgB,aAAa,CAAC,EAAE;YACzD,QAAQ;YACR,SAAS;gBACP,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB,OAAO;gBACP;gBACA,QAAQ;YACV;QACF;QAEA,IAAI,CAAC,IAAI,EAAE,EAAE;YACX,QAAQ,KAAK,CACX,iDACA,IAAI,MAAM;YAEZ,OAAO;QACT;QAEA,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM;QAC1C,MAAM,OAAO,MAAM,YAAY,MAAM,QAAQ;QAE7C,IAAI,CAAC,QAAQ,OAAO,SAAS,UAAU;YACrC,OAAO;QACT;QAEA,OAAO,KAAK,IAAI;IAClB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO;IACT;AACF"}},
    {"offset": {"line": 914, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai/src/lib/ai/releaseNotes.ts"],"sourcesContent":["import type { VersionSnapshot } from \"@/types/publish\";\r\n\r\nconst OLLAMA_ENDPOINT =\r\n  process.env.OLLAMA_ENDPOINT || \"http://localhost:11434\";\r\nconst OLLAMA_MODEL = process.env.OLLAMA_MODEL || \"llama3\";\r\n\r\ntype ReleaseNotesInput = {\r\n  snapshot: VersionSnapshot;\r\n  changelog: string | null;\r\n  productionUrl?: string | null;\r\n};\r\n\r\nfunction buildPrompt(input: ReleaseNotesInput): string {\r\n  const { snapshot, changelog, productionUrl } = input;\r\n\r\n  return `\r\nYou are an assistant that writes professional, concise release notes.\r\n\r\nYou will be given:\r\n- Version number\r\n- Timestamp\r\n- Changelog text\r\n- Production URL (optional)\r\n\r\nWrite a short, clear release note suitable for clients and enterprise users.\r\n\r\nGuidelines:\r\n- Professional tone\r\n- 2–4 bullet points\r\n- No marketing language\r\n- No emojis\r\n- No markdown formatting\r\n- No unnecessary adjectives\r\n\r\nVersion: ${snapshot.version}\r\nTimestamp: ${new Date(snapshot.timestamp).toISOString()}\r\nProduction URL: ${productionUrl ?? \"none\"}\r\n\r\nChangelog:\r\n${changelog ?? \"No changelog available\"}\r\n`;\r\n}\r\n\r\nexport async function generateReleaseNotesWithOllama(\r\n  input: ReleaseNotesInput\r\n): Promise<string | null> {\r\n  try {\r\n    const prompt = buildPrompt(input);\r\n\r\n    const res = await fetch(`${OLLAMA_ENDPOINT}/api/generate`, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify({\r\n        model: OLLAMA_MODEL,\r\n        prompt,\r\n        stream: false,\r\n      }),\r\n    });\r\n\r\n    if (!res.ok) {\r\n      console.error(\"[releaseNotes] Ollama request failed\", res.status);\r\n      return null;\r\n    }\r\n\r\n    const data = await res.json().catch(() => null);\r\n    const text = data?.response ?? data?.text ?? null;\r\n\r\n    if (!text || typeof text !== \"string\") return null;\r\n\r\n    return text.trim();\r\n  } catch (error) {\r\n    console.error(\"[releaseNotes] Ollama error\", error);\r\n    return null;\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAEA,MAAM,kBACJ,QAAQ,GAAG,CAAC,eAAe,IAAI;AACjC,MAAM,eAAe,QAAQ,GAAG,CAAC,YAAY,IAAI;AAQjD,SAAS,YAAY,KAAwB;IAC3C,MAAM,EAAE,QAAQ,EAAE,SAAS,EAAE,aAAa,EAAE,GAAG;IAE/C,OAAO,CAAC;;;;;;;;;;;;;;;;;;;SAmBD,EAAE,SAAS,OAAO,CAAC;WACjB,EAAE,IAAI,KAAK,SAAS,SAAS,EAAE,WAAW,GAAG;gBACxC,EAAE,iBAAiB,OAAO;;;AAG1C,EAAE,aAAa,yBAAyB;AACxC,CAAC;AACD;AAEO,eAAe,+BACpB,KAAwB;IAExB,IAAI;QACF,MAAM,SAAS,YAAY;QAE3B,MAAM,MAAM,MAAM,MAAM,GAAG,gBAAgB,aAAa,CAAC,EAAE;YACzD,QAAQ;YACR,SAAS;gBACP,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB,OAAO;gBACP;gBACA,QAAQ;YACV;QACF;QAEA,IAAI,CAAC,IAAI,EAAE,EAAE;YACX,QAAQ,KAAK,CAAC,wCAAwC,IAAI,MAAM;YAChE,OAAO;QACT;QAEA,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM;QAC1C,MAAM,OAAO,MAAM,YAAY,MAAM,QAAQ;QAE7C,IAAI,CAAC,QAAQ,OAAO,SAAS,UAAU,OAAO;QAE9C,OAAO,KAAK,IAAI;IAClB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO;IACT;AACF"}},
    {"offset": {"line": 980, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai/src/lib/sites/registry.ts"],"sourcesContent":["import { kv } from \"@/lib/kv\";\r\n\r\nconst SITE_REGISTRY_PREFIX = \"buildwithai:sites\";\r\nconst SITE_REGISTRY_INDEX = \"buildwithai:sites:index\";\r\n\r\nexport type SiteRegistryEntry = {\r\n  id: string;\r\n  name: string;\r\n  createdAt: number;\r\n  updatedAt: number;\r\n};\r\n\r\nexport async function registerSite(id: string, name: string) {\r\n  const key = `${SITE_REGISTRY_PREFIX}:${id}`;\r\n  const existing = await kv.get(key);\r\n\r\n  if (existing) return existing;\r\n\r\n  const entry: SiteRegistryEntry = {\r\n    id,\r\n    name,\r\n    createdAt: Date.now(),\r\n    updatedAt: Date.now(),\r\n  };\r\n\r\n  await kv.set(key, entry);\r\n  // Add to index of sites\r\n  try {\r\n    const idx = (await kv.get(SITE_REGISTRY_INDEX)) as string[] | null;\r\n    const nextIdx = Array.isArray(idx) ? Array.from(new Set([...idx, id])) : [id];\r\n    await kv.set(SITE_REGISTRY_INDEX, nextIdx);\r\n  } catch (e) {\r\n    // ignore index update failures\r\n  }\r\n  return entry;\r\n}\r\n\r\nexport async function updateSiteTimestamp(id: string) {\r\n  const key = `${SITE_REGISTRY_PREFIX}:${id}`;\r\n  const entry = (await kv.get(key)) as SiteRegistryEntry | null;\r\n\r\n  if (!entry) return;\r\n\r\n  entry.updatedAt = Date.now();\r\n  await kv.set(key, entry);\r\n}\r\n\r\nexport async function listSites(): Promise<SiteRegistryEntry[]> {\r\n  const idx = (await kv.get(SITE_REGISTRY_INDEX)) as string[] | null;\r\n  const entries: SiteRegistryEntry[] = [];\r\n\r\n  if (!Array.isArray(idx) || idx.length === 0) return entries;\r\n\r\n  for (const id of idx) {\r\n    const key = `${SITE_REGISTRY_PREFIX}:${id}`;\r\n    const entry = await kv.get(key);\r\n    if (entry) entries.push(entry as SiteRegistryEntry);\r\n  }\r\n\r\n  return entries.sort((a, b) => b.updatedAt - a.updatedAt);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM,uBAAuB;AAC7B,MAAM,sBAAsB;AASrB,eAAe,aAAa,EAAU,EAAE,IAAY;IACzD,MAAM,MAAM,GAAG,qBAAqB,CAAC,EAAE,IAAI;IAC3C,MAAM,WAAW,MAAM,uIAAE,CAAC,GAAG,CAAC;IAE9B,IAAI,UAAU,OAAO;IAErB,MAAM,QAA2B;QAC/B;QACA;QACA,WAAW,KAAK,GAAG;QACnB,WAAW,KAAK,GAAG;IACrB;IAEA,MAAM,uIAAE,CAAC,GAAG,CAAC,KAAK;IAClB,wBAAwB;IACxB,IAAI;QACF,MAAM,MAAO,MAAM,uIAAE,CAAC,GAAG,CAAC;QAC1B,MAAM,UAAU,MAAM,OAAO,CAAC,OAAO,MAAM,IAAI,CAAC,IAAI,IAAI;eAAI;YAAK;SAAG,KAAK;YAAC;SAAG;QAC7E,MAAM,uIAAE,CAAC,GAAG,CAAC,qBAAqB;IACpC,EAAE,OAAO,GAAG;IACV,+BAA+B;IACjC;IACA,OAAO;AACT;AAEO,eAAe,oBAAoB,EAAU;IAClD,MAAM,MAAM,GAAG,qBAAqB,CAAC,EAAE,IAAI;IAC3C,MAAM,QAAS,MAAM,uIAAE,CAAC,GAAG,CAAC;IAE5B,IAAI,CAAC,OAAO;IAEZ,MAAM,SAAS,GAAG,KAAK,GAAG;IAC1B,MAAM,uIAAE,CAAC,GAAG,CAAC,KAAK;AACpB;AAEO,eAAe;IACpB,MAAM,MAAO,MAAM,uIAAE,CAAC,GAAG,CAAC;IAC1B,MAAM,UAA+B,EAAE;IAEvC,IAAI,CAAC,MAAM,OAAO,CAAC,QAAQ,IAAI,MAAM,KAAK,GAAG,OAAO;IAEpD,KAAK,MAAM,MAAM,IAAK;QACpB,MAAM,MAAM,GAAG,qBAAqB,CAAC,EAAE,IAAI;QAC3C,MAAM,QAAQ,MAAM,uIAAE,CAAC,GAAG,CAAC;QAC3B,IAAI,OAAO,QAAQ,IAAI,CAAC;IAC1B;IAEA,OAAO,QAAQ,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,SAAS,GAAG,EAAE,SAAS;AACzD"}},
    {"offset": {"line": 1040, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai/src/app/api/publish/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { loadSiteState } from \"@/lib/builder/load\";\r\nimport { exportSiteToStatic } from \"@/lib/export/site\";\r\nimport { injectTracking } from \"@/lib/publisher/inject-tracking\";\r\nimport { validateTracking } from \"@/lib/publisher/validate-tracking\";\r\nimport { triggerVercelDeploy } from \"@/lib/publish/vercel\";\r\nimport { kv } from \"@/lib/kv\";\r\nimport type { PublishMetadata } from \"@/types/publish\";\r\nimport type { PublishHistory, PublishHistoryEntry } from \"@/types/publish\";\r\nimport type { VersionSnapshot } from \"@/types/publish\";\r\nimport { generateChangelogWithOllama } from \"@/lib/ai/changelog\";\r\nimport { generateReleaseNotesWithOllama } from \"@/lib/ai/releaseNotes\";\r\nimport { updateSiteTimestamp } from \"@/lib/sites/registry\";\r\n\r\nconst PUBLISH_KEY_PREFIX = \"buildwithai:site:publish:\";\r\nconst PUBLISH_HISTORY_PREFIX = \"buildwithai:site:publish:history:\";\r\nconst VERSION_SNAPSHOT_PREFIX = \"buildwithai:site:versions:\";\r\nconst PUBLISH_HTML_SNAPSHOT_PREFIX = \"buildwithai:site:html_snapshot:\";\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const body = await req.json().catch(() => ({}));\r\n    const siteId =\r\n      body.siteId ||\r\n      req.nextUrl.searchParams.get(\"siteId\") ||\r\n      undefined;\r\n\r\n    if (!siteId) {\r\n      return NextResponse.json(\r\n        { error: \"Missing siteId\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const state = await loadSiteState(siteId);\r\n    if (!state) {\r\n      return NextResponse.json(\r\n        { error: \"No site state found for this siteId\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Export site (currently not uploaded; used for future enhancements)\r\n    const exported = exportSiteToStatic(state);\r\n\r\n    // Inject tracking into exported HTML\r\n    const finalHtml = injectTracking(exported.html, siteId);\r\n\r\n    // Validate injection before proceeding\r\n    if (!validateTracking(finalHtml)) {\r\n      return NextResponse.json({ error: \"tracking_validation_failed\" }, { status: 422 });\r\n    }\r\n\r\n    // Trigger Vercel Deploy Hook. In local dev we may not have a hook URL —\r\n    // skip the remote trigger but continue the publish flow so snapshots\r\n    // and metadata are still recorded for local validation.\r\n    let skippedDeploy = false;\r\n    let result: { ok: boolean; error?: string } | null = null;\r\n    if (!process.env.VERCEL_DEPLOY_HOOK_URL) {\r\n      console.warn(\"[publish] No VERCEL_DEPLOY_HOOK_URL — skipping deploy trigger (local dev)\");\r\n      skippedDeploy = true;\r\n    } else {\r\n      result = await triggerVercelDeploy(siteId, exported);\r\n      if (!result.ok) {\r\n        return NextResponse.json(\r\n          { error: result.error ?? \"Failed to trigger deploy\" },\r\n          { status: 500 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Save publish metadata\r\n    const key = `${PUBLISH_KEY_PREFIX}${siteId}`;\r\n    const existing = await kv.get(key);\r\n\r\n    const metadata: PublishMetadata = {\r\n      siteId,\r\n      lastPublishedAt: Date.now(),\r\n      lastPublishedVersion: state.metadata?.version ?? null,\r\n      lastPublishedUrl: existing?.lastPublishedUrl ?? null,\r\n    };\r\n\r\n    await kv.set(key, metadata);\r\n\r\n    // Append to publish history\r\n    const historyKey = `${PUBLISH_HISTORY_PREFIX}${siteId}`;\r\n    const existingHistory = (await kv.get(historyKey)) as PublishHistory | null;\r\n\r\n    const entry: PublishHistoryEntry = {\r\n      version: state.metadata?.version ?? 1,\r\n      timestamp: Date.now(),\r\n      url: metadata.lastPublishedUrl,\r\n    };\r\n\r\n    const nextHistory: PublishHistory = Array.isArray(existingHistory)\r\n      ? [...existingHistory, entry]\r\n      : [entry];\r\n\r\n    await kv.set(historyKey, nextHistory);\r\n\r\n    // Store version snapshot\r\n    const snapshotKey = `${VERSION_SNAPSHOT_PREFIX}${siteId}:${metadata.lastPublishedVersion}`;\r\n    const baseSnapshot: VersionSnapshot = {\r\n      version: metadata.lastPublishedVersion ?? 1,\r\n      timestamp: metadata.lastPublishedAt ?? Date.now(),\r\n      state,\r\n      changelog: null,\r\n    };\r\n\r\n    // Load previous snapshot (for changelog diff)\r\n    let previousSnapshot: VersionSnapshot | null = null;\r\n    if (metadata.lastPublishedVersion && metadata.lastPublishedVersion > 1) {\r\n      const prevKey = `${VERSION_SNAPSHOT_PREFIX}${siteId}:${\r\n        (metadata.lastPublishedVersion as number) - 1\r\n      }`;\r\n      const prev = (await kv.get(prevKey)) as VersionSnapshot | null;\r\n      if (prev && typeof prev === \"object\") {\r\n        previousSnapshot = prev;\r\n      }\r\n    }\r\n\r\n    // Generate changelog with Ollama (best-effort; failures are non-fatal)\r\n    const changelog = await generateChangelogWithOllama({\r\n      previous: previousSnapshot,\r\n      current: baseSnapshot,\r\n    });\r\n\r\n    const snapshot: VersionSnapshot = {\r\n      ...baseSnapshot,\r\n      changelog: changelog ?? null,\r\n      releaseNotes: null,\r\n    };\r\n\r\n    await kv.set(snapshotKey, snapshot);\r\n\r\n    // Store HTML snapshot (with tracking injected)\r\n    if (metadata.lastPublishedVersion) {\r\n      const htmlKey = `${PUBLISH_HTML_SNAPSHOT_PREFIX}${siteId}:${metadata.lastPublishedVersion}`;\r\n      await kv.set(htmlKey, finalHtml);\r\n    }\r\n\r\n    // Generate release notes (best-effort)\r\n    const releaseNotes = await generateReleaseNotesWithOllama({\r\n        snapshot,\r\n        changelog: snapshot.changelog ?? null,\r\n        productionUrl: metadata.lastPublishedUrl ?? null,\r\n      });\r\n\r\n    if (releaseNotes) {\r\n      snapshot.releaseNotes = releaseNotes;\r\n      await kv.set(snapshotKey, snapshot);\r\n    }\r\n\r\n    // After successful publish\r\n    await updateSiteTimestamp(siteId);\r\n\r\n    return NextResponse.json({\r\n      ok: true,\r\n      publish: metadata,\r\n      history: nextHistory,\r\n    });\r\n  } catch (error: any) {\r\n    return NextResponse.json(\r\n      { error: error?.message ?? \"Unexpected error in publish API\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;;;;;;;;;;;AAEA,MAAM,qBAAqB;AAC3B,MAAM,yBAAyB;AAC/B,MAAM,0BAA0B;AAChC,MAAM,+BAA+B;AAE9B,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC7C,MAAM,SACJ,KAAK,MAAM,IACX,IAAI,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,aAC7B;QAEF,IAAI,CAAC,QAAQ;YACX,OAAO,+JAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAiB,GAC1B;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,QAAQ,MAAM,IAAA,+JAAa,EAAC;QAClC,IAAI,CAAC,OAAO;YACV,OAAO,+JAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsC,GAC/C;gBAAE,QAAQ;YAAI;QAElB;QAEA,qEAAqE;QACrE,MAAM,WAAW,IAAA,mKAAkB,EAAC;QAEpC,qCAAqC;QACrC,MAAM,YAAY,IAAA,gLAAc,EAAC,SAAS,IAAI,EAAE;QAEhD,uCAAuC;QACvC,IAAI,CAAC,IAAA,oLAAgB,EAAC,YAAY;YAChC,OAAO,+JAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA6B,GAAG;gBAAE,QAAQ;YAAI;QAClF;QAEA,wEAAwE;QACxE,qEAAqE;QACrE,wDAAwD;QACxD,IAAI,gBAAgB;QACpB,IAAI,SAAiD;QACrD,IAAI,CAAC,QAAQ,GAAG,CAAC,sBAAsB,EAAE;YACvC,QAAQ,IAAI,CAAC;YACb,gBAAgB;QAClB,OAAO;YACL,SAAS,MAAM,IAAA,uKAAmB,EAAC,QAAQ;YAC3C,IAAI,CAAC,OAAO,EAAE,EAAE;gBACd,OAAO,+JAAY,CAAC,IAAI,CACtB;oBAAE,OAAO,OAAO,KAAK,IAAI;gBAA2B,GACpD;oBAAE,QAAQ;gBAAI;YAElB;QACF;QAEA,wBAAwB;QACxB,MAAM,MAAM,GAAG,qBAAqB,QAAQ;QAC5C,MAAM,WAAW,MAAM,uIAAE,CAAC,GAAG,CAAC;QAE9B,MAAM,WAA4B;YAChC;YACA,iBAAiB,KAAK,GAAG;YACzB,sBAAsB,MAAM,QAAQ,EAAE,WAAW;YACjD,kBAAkB,UAAU,oBAAoB;QAClD;QAEA,MAAM,uIAAE,CAAC,GAAG,CAAC,KAAK;QAElB,4BAA4B;QAC5B,MAAM,aAAa,GAAG,yBAAyB,QAAQ;QACvD,MAAM,kBAAmB,MAAM,uIAAE,CAAC,GAAG,CAAC;QAEtC,MAAM,QAA6B;YACjC,SAAS,MAAM,QAAQ,EAAE,WAAW;YACpC,WAAW,KAAK,GAAG;YACnB,KAAK,SAAS,gBAAgB;QAChC;QAEA,MAAM,cAA8B,MAAM,OAAO,CAAC,mBAC9C;eAAI;YAAiB;SAAM,GAC3B;YAAC;SAAM;QAEX,MAAM,uIAAE,CAAC,GAAG,CAAC,YAAY;QAEzB,yBAAyB;QACzB,MAAM,cAAc,GAAG,0BAA0B,OAAO,CAAC,EAAE,SAAS,oBAAoB,EAAE;QAC1F,MAAM,eAAgC;YACpC,SAAS,SAAS,oBAAoB,IAAI;YAC1C,WAAW,SAAS,eAAe,IAAI,KAAK,GAAG;YAC/C;YACA,WAAW;QACb;QAEA,8CAA8C;QAC9C,IAAI,mBAA2C;QAC/C,IAAI,SAAS,oBAAoB,IAAI,SAAS,oBAAoB,GAAG,GAAG;YACtE,MAAM,UAAU,GAAG,0BAA0B,OAAO,CAAC,EACnD,AAAC,SAAS,oBAAoB,GAAc,GAC5C;YACF,MAAM,OAAQ,MAAM,uIAAE,CAAC,GAAG,CAAC;YAC3B,IAAI,QAAQ,OAAO,SAAS,UAAU;gBACpC,mBAAmB;YACrB;QACF;QAEA,uEAAuE;QACvE,MAAM,YAAY,MAAM,IAAA,6KAA2B,EAAC;YAClD,UAAU;YACV,SAAS;QACX;QAEA,MAAM,WAA4B;YAChC,GAAG,YAAY;YACf,WAAW,aAAa;YACxB,cAAc;QAChB;QAEA,MAAM,uIAAE,CAAC,GAAG,CAAC,aAAa;QAE1B,+CAA+C;QAC/C,IAAI,SAAS,oBAAoB,EAAE;YACjC,MAAM,UAAU,GAAG,+BAA+B,OAAO,CAAC,EAAE,SAAS,oBAAoB,EAAE;YAC3F,MAAM,uIAAE,CAAC,GAAG,CAAC,SAAS;QACxB;QAEA,uCAAuC;QACvC,MAAM,eAAe,MAAM,IAAA,mLAA8B,EAAC;YACtD;YACA,WAAW,SAAS,SAAS,IAAI;YACjC,eAAe,SAAS,gBAAgB,IAAI;QAC9C;QAEF,IAAI,cAAc;YAChB,SAAS,YAAY,GAAG;YACxB,MAAM,uIAAE,CAAC,GAAG,CAAC,aAAa;QAC5B;QAEA,2BAA2B;QAC3B,MAAM,IAAA,uKAAmB,EAAC;QAE1B,OAAO,+JAAY,CAAC,IAAI,CAAC;YACvB,IAAI;YACJ,SAAS;YACT,SAAS;QACX;IACF,EAAE,OAAO,OAAY;QACnB,OAAO,+JAAY,CAAC,IAAI,CACtB;YAAE,OAAO,OAAO,WAAW;QAAkC,GAC7D;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}