{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai-V0DEV-up/buildwithai-V0DEV-up/operator-app/lib/operator-auth-node.ts"],"sourcesContent":["import fs from \"fs/promises\"\r\nimport path from \"path\"\r\nimport bcrypt from \"bcryptjs\"\r\nimport crypto from \"crypto\"\r\n\r\nexport type OperatorRole = \"admin\" | \"operator\" | \"auditor\"\r\n\r\nexport type OperatorUser = {\r\n  email: string\r\n  passwordHash: string\r\n  role: OperatorRole\r\n  createdAt: string\r\n}\r\n\r\nexport type OperatorSessionPayload = {\r\n  email: string\r\n  role: OperatorRole\r\n  ts: number\r\n}\r\n\r\nconst USER_STORE = path.join(process.cwd(), \"data\", \"operator-users.json\")\r\nconst SESSION_SECRET = process.env.OPERATOR_SESSION_SECRET || \"dev-operator-session-secret\"\r\n\r\nasync function ensureUserStoreDir() {\r\n  await fs.mkdir(path.dirname(USER_STORE), { recursive: true })\r\n}\r\n\r\nfunction normalizeEmail(email: string) {\r\n  return email.trim().toLowerCase()\r\n}\r\n\r\nexport async function readUsers(): Promise<OperatorUser[]> {\r\n  try {\r\n    await ensureUserStoreDir()\r\n    const raw = await fs.readFile(USER_STORE, \"utf8\")\r\n    return JSON.parse(raw) as OperatorUser[]\r\n  } catch (err) {\r\n    return []\r\n  }\r\n}\r\n\r\nexport async function writeUsers(users: OperatorUser[]): Promise<void> {\r\n  await ensureUserStoreDir()\r\n  await fs.writeFile(USER_STORE, JSON.stringify(users, null, 2), \"utf8\")\r\n}\r\n\r\nexport async function findUser(email: string) {\r\n  const users = await readUsers()\r\n  const key = normalizeEmail(email)\r\n  return users.find((u) => normalizeEmail(u.email) === key)\r\n}\r\n\r\nexport async function setUserRole(email: string, role: OperatorRole): Promise<OperatorUser | null> {\r\n  const users = await readUsers()\r\n  const key = normalizeEmail(email)\r\n  const idx = users.findIndex((u) => normalizeEmail(u.email) === key)\r\n  if (idx === -1) return null\r\n  const updated: OperatorUser = { ...users[idx], role }\r\n  users[idx] = updated\r\n  await writeUsers(users)\r\n  return updated\r\n}\r\n\r\nexport async function deleteUser(email: string): Promise<boolean> {\r\n  const users = await readUsers()\r\n  const key = normalizeEmail(email)\r\n  const idx = users.findIndex((u) => normalizeEmail(u.email) === key)\r\n  if (idx === -1) return false\r\n  users.splice(idx, 1)\r\n  await writeUsers(users)\r\n  return true\r\n}\r\n\r\nexport async function createUser(email: string, password: string, role: OperatorRole): Promise<OperatorUser | null> {\r\n  const users = await readUsers()\r\n  const key = normalizeEmail(email)\r\n  if (users.some((u) => normalizeEmail(u.email) === key)) {\r\n    return null\r\n  }\r\n  const passwordHash = await bcrypt.hash(password, 10)\r\n  const user: OperatorUser = { email, passwordHash, role, createdAt: new Date().toISOString() }\r\n  users.push(user)\r\n  await writeUsers(users)\r\n  return user\r\n}\r\n\r\nexport async function loginOperator(email: string, password: string): Promise<OperatorSessionPayload | null> {\r\n  const user = await findUser(email)\r\n  if (!user) return null\r\n  const ok = await bcrypt.compare(password, user.passwordHash)\r\n  if (!ok) return null\r\n  return { email: user.email, role: user.role, ts: Date.now() }\r\n}\r\n\r\nexport function createSignedSessionToken(payload: OperatorSessionPayload) {\r\n  const payloadB64 = Buffer.from(JSON.stringify(payload)).toString(\"base64url\")\r\n  const signature = crypto.createHmac(\"sha256\", SESSION_SECRET).update(payloadB64).digest(\"hex\")\r\n  return `${payloadB64}.${signature}`\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;;;;;AAiBA,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ;AACpD,MAAM,iBAAiB,QAAQ,GAAG,CAAC,uBAAuB,IAAI;AAE9D,eAAe;IACb,MAAM,gIAAE,CAAC,KAAK,CAAC,4GAAI,CAAC,OAAO,CAAC,aAAa;QAAE,WAAW;IAAK;AAC7D;AAEA,SAAS,eAAe,KAAa;IACnC,OAAO,MAAM,IAAI,GAAG,WAAW;AACjC;AAEO,eAAe;IACpB,IAAI;QACF,MAAM;QACN,MAAM,MAAM,MAAM,gIAAE,CAAC,QAAQ,CAAC,YAAY;QAC1C,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAO,KAAK;QACZ,OAAO,EAAE;IACX;AACF;AAEO,eAAe,WAAW,KAAqB;IACpD,MAAM;IACN,MAAM,gIAAE,CAAC,SAAS,CAAC,YAAY,KAAK,SAAS,CAAC,OAAO,MAAM,IAAI;AACjE;AAEO,eAAe,SAAS,KAAa;IAC1C,MAAM,QAAQ,MAAM;IACpB,MAAM,MAAM,eAAe;IAC3B,OAAO,MAAM,IAAI,CAAC,CAAC,IAAM,eAAe,EAAE,KAAK,MAAM;AACvD;AAEO,eAAe,YAAY,KAAa,EAAE,IAAkB;IACjE,MAAM,QAAQ,MAAM;IACpB,MAAM,MAAM,eAAe;IAC3B,MAAM,MAAM,MAAM,SAAS,CAAC,CAAC,IAAM,eAAe,EAAE,KAAK,MAAM;IAC/D,IAAI,QAAQ,CAAC,GAAG,OAAO;IACvB,MAAM,UAAwB;QAAE,GAAG,KAAK,CAAC,IAAI;QAAE;IAAK;IACpD,KAAK,CAAC,IAAI,GAAG;IACb,MAAM,WAAW;IACjB,OAAO;AACT;AAEO,eAAe,WAAW,KAAa;IAC5C,MAAM,QAAQ,MAAM;IACpB,MAAM,MAAM,eAAe;IAC3B,MAAM,MAAM,MAAM,SAAS,CAAC,CAAC,IAAM,eAAe,EAAE,KAAK,MAAM;IAC/D,IAAI,QAAQ,CAAC,GAAG,OAAO;IACvB,MAAM,MAAM,CAAC,KAAK;IAClB,MAAM,WAAW;IACjB,OAAO;AACT;AAEO,eAAe,WAAW,KAAa,EAAE,QAAgB,EAAE,IAAkB;IAClF,MAAM,QAAQ,MAAM;IACpB,MAAM,MAAM,eAAe;IAC3B,IAAI,MAAM,IAAI,CAAC,CAAC,IAAM,eAAe,EAAE,KAAK,MAAM,MAAM;QACtD,OAAO;IACT;IACA,MAAM,eAAe,MAAM,mMAAM,CAAC,IAAI,CAAC,UAAU;IACjD,MAAM,OAAqB;QAAE;QAAO;QAAc;QAAM,WAAW,IAAI,OAAO,WAAW;IAAG;IAC5F,MAAM,IAAI,CAAC;IACX,MAAM,WAAW;IACjB,OAAO;AACT;AAEO,eAAe,cAAc,KAAa,EAAE,QAAgB;IACjE,MAAM,OAAO,MAAM,SAAS;IAC5B,IAAI,CAAC,MAAM,OAAO;IAClB,MAAM,KAAK,MAAM,mMAAM,CAAC,OAAO,CAAC,UAAU,KAAK,YAAY;IAC3D,IAAI,CAAC,IAAI,OAAO;IAChB,OAAO;QAAE,OAAO,KAAK,KAAK;QAAE,MAAM,KAAK,IAAI;QAAE,IAAI,KAAK,GAAG;IAAG;AAC9D;AAEO,SAAS,yBAAyB,OAA+B;IACtE,MAAM,aAAa,OAAO,IAAI,CAAC,KAAK,SAAS,CAAC,UAAU,QAAQ,CAAC;IACjE,MAAM,YAAY,gHAAM,CAAC,UAAU,CAAC,UAAU,gBAAgB,MAAM,CAAC,YAAY,MAAM,CAAC;IACxF,OAAO,GAAG,WAAW,CAAC,EAAE,WAAW;AACrC"}},
    {"offset": {"line": 177, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai-V0DEV-up/buildwithai-V0DEV-up/operator-app/lib/operator-audit.ts"],"sourcesContent":["import fs from \"fs/promises\"\r\nimport path from \"path\"\r\nimport crypto from \"crypto\"\r\n\r\nexport type OperatorAuditAction =\r\n  | \"login-success\"\r\n  | \"login-failed\"\r\n  | \"logout\"\r\n  | \"user-add\"\r\n  | \"user-delete\"\r\n  | \"user-role-change\"\r\n  | \"access-denied\"\r\n  | \"view-users\"\r\n\r\nexport type OperatorAuditEntry = {\r\n  id: string\r\n  ts: number\r\n  actorEmail?: string\r\n  actorRole?: string\r\n  action: OperatorAuditAction\r\n  targetEmail?: string\r\n  details?: string\r\n  ip?: string\r\n  userAgent?: string\r\n}\r\n\r\nconst AUDIT_STORE = path.join(process.cwd(), \"data\", \"operator-audit.json\")\r\n\r\nasync function ensureAuditDir() {\r\n  await fs.mkdir(path.dirname(AUDIT_STORE), { recursive: true })\r\n}\r\n\r\nexport async function readAudit(): Promise<OperatorAuditEntry[]> {\r\n  try {\r\n    await ensureAuditDir()\r\n    const raw = await fs.readFile(AUDIT_STORE, \"utf8\")\r\n    return JSON.parse(raw) as OperatorAuditEntry[]\r\n  } catch (err) {\r\n    return []\r\n  }\r\n}\r\n\r\nexport async function writeAudit(entries: OperatorAuditEntry[]): Promise<void> {\r\n  await ensureAuditDir()\r\n  await fs.writeFile(AUDIT_STORE, JSON.stringify(entries, null, 2), \"utf8\")\r\n}\r\n\r\nexport async function logOperatorAction(entry: Omit<OperatorAuditEntry, \"id\" | \"ts\">) {\r\n  const existing = await readAudit()\r\n  const record: OperatorAuditEntry = {\r\n    id: crypto.randomUUID(),\r\n    ts: Date.now(),\r\n    ...entry,\r\n  }\r\n  existing.push(record)\r\n  await writeAudit(existing)\r\n  return record\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AACA;;;;AAwBA,MAAM,cAAc,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ;AAErD,eAAe;IACb,MAAM,gIAAE,CAAC,KAAK,CAAC,4GAAI,CAAC,OAAO,CAAC,cAAc;QAAE,WAAW;IAAK;AAC9D;AAEO,eAAe;IACpB,IAAI;QACF,MAAM;QACN,MAAM,MAAM,MAAM,gIAAE,CAAC,QAAQ,CAAC,aAAa;QAC3C,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAO,KAAK;QACZ,OAAO,EAAE;IACX;AACF;AAEO,eAAe,WAAW,OAA6B;IAC5D,MAAM;IACN,MAAM,gIAAE,CAAC,SAAS,CAAC,aAAa,KAAK,SAAS,CAAC,SAAS,MAAM,IAAI;AACpE;AAEO,eAAe,kBAAkB,KAA4C;IAClF,MAAM,WAAW,MAAM;IACvB,MAAM,SAA6B;QACjC,IAAI,gHAAM,CAAC,UAAU;QACrB,IAAI,KAAK,GAAG;QACZ,GAAG,KAAK;IACV;IACA,SAAS,IAAI,CAAC;IACd,MAAM,WAAW;IACjB,OAAO;AACT"}},
    {"offset": {"line": 225, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/AjaySidal/buildwithai-V0DEV-up/buildwithai-V0DEV-up/operator-app/app/api/operator/login/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport { loginOperator, createSignedSessionToken } from \"@/lib/operator-auth-node\"\r\nimport { logOperatorAction } from \"@/lib/operator-audit\"\r\n\r\nexport const runtime = \"nodejs\"\r\n\r\nconst ATTEMPT_WINDOW_MS = 15 * 60 * 1000\r\nconst MAX_ATTEMPTS = 5\r\nconst loginAttempts = new Map<string, { count: number; first: number }>()\r\n\r\nfunction getClientMeta(request: Request) {\r\n  const ip = request.headers.get(\"x-forwarded-for\")?.split(\",\")[0]?.trim() || request.headers.get(\"x-real-ip\") || undefined\r\n  const userAgent = request.headers.get(\"user-agent\") || undefined\r\n  return { ip, userAgent }\r\n}\r\n\r\nfunction normalizeKey(email: string) {\r\n  return email.trim().toLowerCase()\r\n}\r\n\r\nfunction isRateLimited(key: string) {\r\n  const now = Date.now()\r\n  const entry = loginAttempts.get(key)\r\n  if (!entry) return false\r\n  if (now - entry.first > ATTEMPT_WINDOW_MS) {\r\n    loginAttempts.delete(key)\r\n    return false\r\n  }\r\n  return entry.count >= MAX_ATTEMPTS\r\n}\r\n\r\nfunction recordFailedAttempt(key: string) {\r\n  const now = Date.now()\r\n  const entry = loginAttempts.get(key)\r\n  if (!entry || now - entry.first > ATTEMPT_WINDOW_MS) {\r\n    loginAttempts.set(key, { count: 1, first: now })\r\n  } else {\r\n    loginAttempts.set(key, { count: entry.count + 1, first: entry.first })\r\n  }\r\n}\r\n\r\nfunction clearAttempts(key: string) {\r\n  loginAttempts.delete(key)\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const body = await request.json().catch(() => null)\r\n    const email = body?.email as string | undefined\r\n    const password = body?.password as string | undefined\r\n    const meta = getClientMeta(request)\r\n\r\n    if (!email || !password) {\r\n      return NextResponse.json({ error: \"Email and password are required\" }, { status: 400 })\r\n    }\r\n\r\n    const key = normalizeKey(email)\r\n\r\n    if (isRateLimited(key)) {\r\n      await logOperatorAction({ action: \"access-denied\", targetEmail: email, details: \"login rate limited\", ...meta })\r\n      return NextResponse.json({ error: \"Too many login attempts. Please try again later.\" }, { status: 429 })\r\n    }\r\n\r\n    const session = await loginOperator(email, password)\r\n    if (!session) {\r\n      recordFailedAttempt(key)\r\n      await logOperatorAction({ action: \"login-failed\", targetEmail: email, details: \"invalid credentials\", ...meta })\r\n      return NextResponse.json({ error: \"Invalid credentials\" }, { status: 401 })\r\n    }\r\n\r\n    const token = createSignedSessionToken(session)\r\n    const res = NextResponse.json({ success: true })\r\n    res.cookies.set(\"operator_session\", token, {\r\n      httpOnly: true,\r\n      secure: process.env.NODE_ENV === \"production\",\r\n      sameSite: \"lax\",\r\n      path: \"/\",\r\n      maxAge: 60 * 60 * 24,\r\n    })\r\n    clearAttempts(key)\r\n    await logOperatorAction({ action: \"login-success\", actorEmail: session.email, actorRole: session.role, ...meta })\r\n    return res\r\n  } catch (err) {\r\n    return NextResponse.json({ error: \"Unexpected error\" }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}